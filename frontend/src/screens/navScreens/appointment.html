<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="src/styles/style.css">
    <script src="navigation/navigation.js" defer></script>
    <title>Appointment Form</title>
    <style>
        /* --- STYLES (UNCHANGED) --- */
        .form-section { border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 25px; }
        .form-section legend { padding: 0 10px; font-weight: bold; color: #333; font-size: 1.2em; }
        .input-with-button { position: relative; width: 100%; margin-bottom: 15px; }
        .input-with-button input { width: 100%; padding-right: 85px; box-sizing: border-box; }
        .edit-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-90%); background-color: #6c757d; color: white; border: none; padding: 5px 10px; font-size: 12px; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; }
        .edit-btn:hover { background-color: #5a6268; }
        input.pre-filled { background-color: #e9ecef; color: #495057; cursor: not-allowed; border: 1px solid #ced4da; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; text-align: center; border-radius: 8px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer; }
        .btn { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-top: 15px; }
        .btn:hover { background-color: #0056b3; }
        .time-box{ margin-top: 25px; margin-left: 18px;  }
        /* --- STYLES FOR SIDE-BY-SIDE LAYOUT (WITH THE FIX) --- */
        .form-row {
            display: flex;
            gap: 20px; 
            /* This is the new, corrected alignment property */
            align-items: baseline; 
        }
        .form-group {
            flex: 1; 
            margin-bottom: 15px;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
        }
        .form-group-date {
            flex: none;
            width: 45%; 
        }
    </style>
</head>
<body>
    <div id="navbar-placeholder"></div>

    <div class="appointment-wrapper">
        <div class="appointment-container">
            <h2 class="form-title">Patient Appointment Form</h2>
            <div id="form-message-area" style="text-align:center; margin-bottom:15px; font-weight:bold; min-height: 1.2em;"></div>

            <form id="userDataForm" method="POST" action="/save-data">

                <!-- SECTION 1: USER INFORMATION (Unchanged) -->
                <fieldset class="form-section">
                    <legend>Your Information</legend>
                    <label for="patientName">Name*</label>
                    <div class="input-with-button">
                        <input type="text" id="patientName" name="patientName" required placeholder="Name">
                        <button type="button" class="edit-btn" data-target="patientName">Change</button>
                    </div>
                    <label for="age">Age*</label>
                    <div class="input-with-button">
                        <input type="number" id="age" name="age" required placeholder="Age">
                        <button type="button" class="edit-btn" data-target="age">Change</button>
                    </div>
                    <label for="phone">Phone Number*</label>
                    <div class="input-with-button">
                        <input type="tel" id="phone" name="phone" required placeholder="Phone">
                        <button type="button" class="edit-btn" data-target="phone">Change</button>
                    </div>
                    <label for="address">Address*</label>
                    <div class="input-with-button">
                        <input type="text" id="address" name="address" required placeholder="Address">
                        <button type="button" class="edit-btn" data-target="address">Change</button>
                    </div>
                </fieldset>

                <!-- SECTION 2: APPOINTMENT DETAILS (Unchanged HTML, but will render correctly with new CSS) -->
                <fieldset class="form-section">
                    <legend>Appointment Details</legend>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="specialization">Specialization*</label>
                            <select id="specialization" name="specialization" required>
                                <option value="">Select Specialization</option>
                                <option value="SURGERY">Surgery</option>
                                <option value="CARDIOLOGY">Cardiology</option>
                                <option value="DERMATOLOGY">Dermatology</option>
                                <option value="DENTISTRY">Dentistry</option>
                                <option value="OBSTETRICS GYNECOLOGY">Obstetrics & Gynecology</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="doctorName">Doctor*</label>
                            <select id="doctorName" name="doctorName" required disabled>
                                <option value="">Select a specialization first</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group form-group-date">
                            <label for="date">Date*</label>
                            <input type="date" id="date" name="date" required>
                        </div>
                        <div class="form-group">
                            <label for="time">Time*</label>
                            <div class="time-box">
                                <select id="time" name="time" required>
                                    <option value="">Select Time</option>
                                    <option value="09:00 AM">09:00 AM</option>
                                    <option value="09:30 AM">09:30 AM</option>
                                    <option value="10:00 AM">10:00 AM</option>
                                    <option value="10:30 AM">10:30 AM</option>
                                    <option value="11:00 AM">11:00 AM</option>
                                    <option value="11:30 AM">11:30 AM</option>
                                    <option value="01:00 PM">01:00 PM</option>
                                    <option value="01:30 PM">01:30 PM</option>
                                    <option value="02:00 PM">02:00 PM</option>
                                    <option value="02:30 PM">02:30 PM</option>
                                    <option value="03:00 PM">03:00 PM</option>
                                    <option value="03:30 PM">03:30 PM</option>
                                    <option value="04:00 PM">04:00 PM</option>
                                    <option value="04:30 PM">04:30 PM</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="reason">Reason for Appointment*</label>
                        <textarea id="reason" name="reason" rows="3" placeholder="e.g. Regular Check-up" required></textarea>
                    </div>
                </fieldset>

                <button type="submit">Submit Appointment</button>
            </form>
        </div>
    </div>
    
    <footer class="footer"></footer>
    <div id="confirmationModal" class="modal"></div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // --- 1. USER INFO LOGIC ---
            try {
                const response = await fetch('/getUser');
                const userData = await response.json();
                if (userData.loggedIn) {
                    const fieldsToLock = { patientName: userData.fullname, age: userData.age, phone: userData.phoneNumber, address: userData.address };
                    for (const id in fieldsToLock) {
                        const input = document.getElementById(id);
                        const value = fieldsToLock[id];
                        const changeButton = document.querySelector(`.edit-btn[data-target="${id}"]`);
                        if (input && value) {
                            input.value = value;
                            input.readOnly = true;
                            input.classList.add('pre-filled');
                        } else if (changeButton) {
                            changeButton.style.display = 'none';
                        }
                    }
                } else {
                    document.querySelectorAll('.edit-btn').forEach(btn => btn.style.display = 'none');
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
                document.querySelectorAll('.edit-btn').forEach(btn => btn.style.display = 'none');
            }
            
            document.querySelectorAll('.edit-btn').forEach(button => {
                const targetInputId = button.dataset.target;
                const inputToEdit = document.getElementById(targetInputId);
                const relockField = () => {
                    inputToEdit.readOnly = true;
                    inputToEdit.classList.add('pre-filled');
                    button.style.display = 'inline-block';
                };
                button.addEventListener('click', function() {
                    inputToEdit.readOnly = false;
                    inputToEdit.classList.remove('pre-filled');
                    inputToEdit.focus();
                    this.style.display = 'none';
                });
                inputToEdit.addEventListener('blur', relockField);
                inputToEdit.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        relockField();
                    }
                });
            });

            // --- 2. SMART APPOINTMENT FORM LOGIC ---
            const specializationSelect = document.getElementById('specialization');
            const doctorSelect = document.getElementById('doctorName');

            const doctorSpecializations = {
                'SURGERY': ['Alarcon, Mark', 'Dr. Reyes, John'],
                'CARDIOLOGY': ['De Guzman, Jatrish', 'Dr. Clara Santos'],
                'DERMATOLOGY': ['Dr. Villanueva, Anne'],
                'DENTISTRY': ['Matthew, Martin'],
                'OBSTETRICS GYNECOLOGY': ['Brian, Yvonne']
            };

            function updateDoctorOptions() {
                const selectedSpec = specializationSelect.value;
                doctorSelect.innerHTML = ''; 
                if (selectedSpec) {
                    doctorSelect.disabled = false;
                    doctorSelect.add(new Option('Select a Doctor', ''));
                    const doctors = doctorSpecializations[selectedSpec] || [];
                    doctors.forEach(doctor => doctorSelect.add(new Option(doctor, doctor)));
                } else {
                    doctorSelect.disabled = true;
                    doctorSelect.add(new Option('Select a specialization first', ''));
                }
            }
            specializationSelect.addEventListener('change', updateDoctorOptions);
            updateDoctorOptions();

            // --- 3. URL PARAMS LOGIC ---
            const urlParams = new URLSearchParams(window.location.search);
            const errorMsg = urlParams.get('error');
            if (errorMsg) {
                document.getElementById('form-message-area').textContent = decodeURIComponent(errorMsg);
                document.getElementById('form-message-area').style.color = 'red';
            }
            const doctorParam = urlParams.get('doctor');
            const specParam = urlParams.get('specialization');
            if (specParam) { // Set specialization first
                specializationSelect.value = decodeURIComponent(specParam);
                updateDoctorOptions(); // Update doctors based on spec
            }
            if (doctorParam) { // Then set the doctor
                doctorSelect.value = decodeURIComponent(doctorParam);
            }
        });
    </script>
    <script src="src/app.js" type="module" defer></script>
</body>
</html>